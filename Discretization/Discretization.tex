\documentclass[../Main/main.tex]{subfiles}

\begin{document}
	\graphicspath{{../Discretization/figs/}}
	\chapter{Discretization}
	\section*{Finite Element Method}
	\addcontentsline{toc}{section}{Finite Element Method}
	The finite element method was first developed in the 1940s by Richard Courant for problems in solid mechanics. As computers became better in the 1960s the method became  more mainstream \cite{Stein2014}. Today there are several general purpose finite element programs being used for a wide range of problems.\\
	In this chapter we will introduce the finite element method and state results about stability and convergence.
	We will concentrate on solving the Poisson equation, let $\Omega \subset \mathbb{R}^n$ be some open, bounded domain. Find $u$ such that:
	\begin{equation} \label{eq:poisson}
		\begin{split}
			-\nabla \cdot \pmb{K} \nabla u(x) &= F(x) \ \  x\in \Omega \\ 
			u(x) &= 0 \ \ x\in \partial \Omega.
		\end{split}
	\end{equation}
	For this equation to be well defined we require that $u$ has double derivatives in $\Omega$, but it is easy to come across physical examples where this does not make sense.
	This is some of the motivation for formulating the Poisson equation in the \emph{variational formulation}. Another motivation is that it allows for an nice framework for computing the solution, as we will soon see. But first, we study some spaces of functions and their properties.
	
	
	\subsection*{Function spaces}
	\addcontentsline{toc}{subsection}{Function spaces}
	When discussing PDE's and the numerical schemes to solve them it is important to have a precise notion of what kind of functions we are looking for and their properties. The function spaces discussed here are all normed vector spaces. From now on we assume that $\Omega \subset \mathbb{R}^d$ is a bounded domain.
	\begin{definition}[Lebesgue spaces, $L^p(\Omega)$]
		For $p\in [1,\infty]$ let $L^p(\Omega)$ be the space of functions for which  $\left \| u \right \|_p = (\int_{\Omega} u^pdx)^{1/p} <\infty$
	\end{definition}

	\begin{remark}
		Note that a $L^p$ space induces equivalence relations on the set of functions. Two functions in $L^p$ are equal if they only differ on a set of measure zero.
	\end{remark}
	An important concept when discussing vector spaces are that they intuitively does not have any points missing, this is formally defined as spaces where every Cauchy sequence converges. This is known as \emph{complete} vector spaces or \emph{Banach spaces}.
	
	\begin{theorem}[Riesz-Fischer Theorem \cite{Cheney} chapter 8]\label{theorem:Riesz-Fischer}
		Each $L^p$ space is a Banach space.
	\end{theorem}
	\begin{remark}
		The space $L^2(\Omega)$ is a inner-product space, with inner product $\left \langle u,v\right \rangle_{L^2} = \int_{\Omega}uv \ dx$, Banach spaces with an inner product are called \textbf{Hilbert spaces}
	\end{remark}
	
	
	
	
	Before we continue the study of funtion spaces we develop some convinient notation for derivatives.
	
	\begin{definition}[multi index notation]
		Let $\overline{\alpha}$ be an ordered n-tuple. We call this a multi-index and denote the length $|\overline{\alpha}| = \sum_{i=1}^n 		\alpha_i$.
		Let $\phi \in C^{\infty}(\Omega)$ we define $D^{\overline{\alpha}} = (\frac{\partial }{\partial x_1})^{\alpha_1}(\frac{\partial }{\partial x_2})^{\alpha_2}...(\frac{\partial }{\partial x_n})^{\alpha_n}\phi$
	\end{definition}
	
	We would also like a more general notion of derivative than the one presented in the basic calculus books.
	\begin{definition}[weak derivative]
		Let $L_{loc}^1(\Omega) =\left \{  \right. f\in L^1(K):\forall K \in \Omega \text{  where K is compact}\left.  \right \}$.
		Let $f \in L_{loc}^1(\Omega)$. If there exists $g\in L_{loc}^1 (\Omega)$ such that \\
		$\int_{\Omega} g \phi dx = (-1)^{|\overline{\alpha}|} \int_{\Omega} f D^{\overline{\alpha}} \phi dx \ \ \forall \phi \in C^{\infty}$ with $\phi = 0$ on $\partial \Omega$ \\ we say that $g$ is the weak derivative of $f$ and denote it by $D_w^{\overline{\alpha}}f$.
	\end{definition}
	
	
	We can now define a class of subspaces of the $L^p$ spaces known as the \textbf{Sobolev spaces}
	\begin{definition}[Sobolev space]
		Let $k$ be a non-negative integer, define the Sobolev norm as 
		\begin{equation*}
			\left \| u \right \|_{W^{k,p}(\Omega)} := (\sum_{|\overline{\alpha}| \leq k} \left \| D_w^{\overline{\alpha}}u \right \|_{L^p(\Omega)}^p)^{1/p}.
		\end{equation*}
		We then define the sovolev spaces as 
		\begin{equation*}
			W^{k,p}(\Omega) = \left \{  \right. f\in L^1_{loc}(\Omega):\left \| f \right \|_{W^{k,p}}<\infty\left.  \right \}
		\end{equation*}
	\end{definition}
	\begin{theorem}
		The sobolev spaces $W^{k,p}(\Omega)$ are Banach spaces
	\end{theorem}
	
	\begin{proof}
		Let $\left \{  u_i\right \}_{i=0}^{\infty} \subseteq W^{k,p}(\Omega)$ be a cauchy sequence. This implies that for all $\overline{\alpha}, \  |\overline{\alpha}| \leq k$ we have a cauchy sequence in $L^p(\Omega)$.
		\begin{gather*}
			\left \| u_j -u_i \right \|_{W^{k,p}} =
			(\sum_{|\overline{\alpha}|\leq k} \left \| D_w^{\overline{\alpha}}u_j - D_w^{\overline{\alpha}}u_i \right \|_{L^p(\Omega)}^p)^{1/p}  < \epsilon \ \forall i,j \geq N \\
			\implies \left \| D_w^{\overline{\alpha}}u_j - D_w^{\overline{\alpha}}u_i \right \|_{L^p(\Omega)} < \epsilon
		\end{gather*}
		By \eqref{theorem:Riesz-Fischer} we know that $D_w^{\overline{\alpha}}u_i \rightarrow u_{\overline{\alpha}}$ as $i\rightarrow  \infty$. In particular $u_i \rightarrow u$, so now we just need to show that $D_w^{\overline{\alpha}}u =  u_{\overline{\alpha}}$. By the definition of weak derivative we have:
		\begin{gather*}
			\int_{\Omega} D_w^{\overline{\alpha}}u_i \phi dx = (-1)^{|\overline{\alpha}} \int_{\Omega} u_i D^{\overline{\alpha}}\phi dx
		\end{gather*}
		Now applying HÃ¶lder's inequality on both sides we get the two inequalities:
		\begin{gather*}
			\int_{\Omega} (D_w^{\overline{\alpha}}u_i - u_{\overline{\alpha}}) \phi dx \leq \left \| (D_w^{\overline{\alpha}}u_i - u_{\overline{\alpha}} \right \|_{L_p} \left \| \phi \right \|_{L_q} \\
			\int_{\Omega} (u_i -u) D^{\overline{\alpha}}\phi dx \leq \left \|u_i -u  \right \|_{L_p} \left \| D^{\overline{\alpha}}\phi \right \|_{L_q}
		\end{gather*}
		Taking the limit, the right hand side goes to zero, and we end up with the fact that we can move the limit out of the integral:
		\begin{gather*}
			\lim_{i\rightarrow \infty} \int_{\Omega} D_w^{\overline{\alpha}}u_i \phi dx =  \int_{\Omega}u_{\overline{\alpha}} \phi dx \\
			\lim_{i\rightarrow \infty}\int_{\Omega} u_i D^{\overline{\alpha}}\phi dx = \int_{\Omega} u  D^{\overline{\alpha}}\phi dx
		\end{gather*}
		Now we can put the two equations together to obtain $D_w^{\overline{\alpha}}u =  u_{\overline{\alpha}}$
		\begin{equation*}
			\int_{\Omega}u_{\overline{\alpha}} \phi dx = \lim_{i\rightarrow \infty} \int_{\Omega} D_w^{\overline{\alpha}}u_i \phi dx = \lim_{i\rightarrow \infty}\int_{\Omega} u_i D^{\overline{\alpha}}\phi dx = \int_{\Omega} u  D^{\overline{\alpha}}\phi dx
		\end{equation*}
	\end{proof}
	\begin{definition}
		We rename the $L^2$ based Sobolev spaces as follows 
		\begin{equation*}
			H^k(\Omega) = W^{k,2}(\Omega)
		\end{equation*}
		With the norm of $H^k$ beieng written in the more compact forms $\left \| \cdot \right \|_k$ and the inner product defined as follows:
		\begin{equation*}
			\left \langle u,v \right \rangle_k = \sum_{|\overline{\alpha}| \leq k} \int_{\Omega}D_w^{\overline{\alpha}}u,D_w^{\overline{\alpha}}v dx
		\end{equation*}
	\end{definition}

	In Sobolev spaces it is not obvious that a function is well defined on a lower dimensional subset of $\Omega$, because two functions may map elements of this zero meassure subset to different values and still be of the same equivalence class. This is important to settle if we want to solve boundary value problems. The following results are stated for general $p$ based Sobolev spaces, but we will only use them for the Hilbert space $H^1$.
	\begin{definition}
		We denote by $H_0^{k}(\Omega)$ the closure of $C_c^{\infty}(\Omega)$ in $H^{k}(\Omega)$, where $C_c^{\infty}(\Omega)$ is the space of infinitely differentiable functions with compact support.
	\end{definition}
	\begin{theorem}[Trace theorem, (Evans \cite{evans10}, chapter 5)]
		Assume $U$ is bounded and $\partial U$ is $C^1$. Then there exists a bounded, linear operator
		\begin{equation*}
			T: H^{1}(U) \rightarrow L^2(\partial U)
		\end{equation*}
		Such that
		\begin{enumerate}
			\item $ Tu = u|_{\partial u} $ if $u\in H^{1}\cap C(\overline{U})$
			\item $\left \|Tu\right\|_{L^p(\partial U)}\leq \left \| u \right \|_{H^{1}(U)}$
		\end{enumerate}
	\end{theorem}
	We call $Tu$ the trace of $u$. Note that the theorem does not state that $T$ is surjecvtive.
	\begin{theorem}(Trace-zero functions in $W^{1,p}$,(Evans \cite{evans10}, chapter 5))
		Suppose $U$ is as in the previous theorem and $u\in W^{1,p}(U)$, then
		\begin{equation*}
			u\in H^{1}_0 \Leftrightarrow  Tu=0 \textit{ on }\partial U
		\end{equation*}
	\end{theorem}
	
	\begin{remark}
		We often denote the image of $T$ as:
		\begin{equation*}
			 H^{\frac{1}{2}}(\Omega) = T(H^1(\Omega))
		\end{equation*}
		And define the norm
		\begin{equation*}
			\left \|f\right \|_{H^{\frac{1}{2}}(\Omega)} = \inf_{w\in H^1(\Omega), \ Tw=f} \left \| w \right \|_1
		\end{equation*}
	\end{remark}
	Now we have the theory we need to study elliptic boundary value problems and their weak solutions.
	\subsection*{The variational problem}
	\addcontentsline{toc}{subsection}{The variational problem}
	We obtain the \textbf{variational formulation} by multiplying \eqref{eq:poisson} by a function $v$ in a suitable space $V$ called the \emph{test space}, integrating over $\Omega$ and using integration by parts/divergence theorem.
	\begin{equation*}
		-\int_{\Omega}v\nabla \cdot\pmb{K}\nabla u \ dx = -\int_{\partial \Omega}v \pmb{K}\nabla u \cdot \pmb{n} \ dx + \int_{\Omega}(\nabla v)^{T}\pmb{K} \nabla u \ dx = \int_{\Omega}v F \ dx
	\end{equation*}
	If we choose $v$ such that $v=0$ on $\partial \Omega$ the integral over the boundary vanishes. So the new formulation now reads: find $u$ such that 
	\begin{equation}\label{eq:variational poisson}
			 \int_{\Omega}(\nabla v)^T \pmb{K} \nabla u \ dx = \int_{\Omega}v F \ dx \ \ \  \forall v \in V.
	\end{equation}
	A good choice of the test space $V$ is $V=H_0^1(\Omega)$. We also choose this as the solution space.
	We see that if $u$ is a solution to \eqref{eq:poisson}, it also solves \eqref{eq:variational poisson}. But a solution to \eqref{eq:variational poisson} does not necessarily solve \eqref{eq:poisson}, that is why it is also called the \emph{weak formulation}.\\
	The variational problems that we will look at, that arises from PDE's, will all have the form: Find $u$ such that
	\begin{equation}\label{eq:variational problem}
			a(u,v) = b(v) \ \ \ \forall v \in V,
	\end{equation}
	where $a(\cdot,\cdot)$ is a \emph{bi linear form} on $V$ and $b(\cdot)$ is a \emph{linear functional} on $V$. To be precise we define a famous concept from functional analysis:
	\begin{definition}[dual space]
		Let $V$ be a normed vector space, then we define it's dual space as the space of functions from $V$ to $\mathbb{R}$ that are linear and continuous, also called linear functionals. We denote it by $V^{'}$. This is a normed vector space with the norm: \begin{equation*}
\left \| u \right \|_{V'} = \sup_{\left \| v \right \|=1}\left \{ |u(v)|:v\in V \right \}. 		\end{equation*}
	\end{definition}
	In general, a variational formulation can we seen as finding the element in a Banach space that is mapped to an element in it's dual space by some linear map.
	\subsubsection*{Boundary conditions}
	Let $\partial \Omega = \Gamma_D\bigcup \Gamma_N$ with $\Gamma_D \bigcap \Gamma_N = \emptyset$, then \eqref{eq:poisson} with more complicated boundary conditions can be written:
	\begin{equation}\label{eq:inhomogenous poisson}
		\begin{aligned}[c]
			 - \nabla \cdot \pmb{K} \nabla \hat{u}(x) &= F(x) \\
			\hat{u}(x) &= g_D \\
			\pmb{K}\nabla \hat{u}(x) &= g_N
		\end{aligned}
		\ \ \
		\begin{aligned}[c]
			x &\in \Omega  \\
			x &\in \Gamma_D \\
			x &\in \Gamma_N
		\end{aligned}
	\end{equation}
	To make a variational formulation of \eqref{eq:inhomogenous poisson} we first define the test space:
	\begin{equation*}
		V = \left \{ v\in H^1(\Omega): T(v)=0 \text{ on }\Gamma_D\right \}
	\end{equation*}
	Next, assume there exists an element $w$ of $ H^1(\Omega)$ that are mapped by the trace operator such that Dirichlet boundary conditions are met: $T(w)=g_D$. Let $\hat{u} = u+w$, now we can use integration by parts to as before:
	\begin{equation}
		a(u+w,v) = \int_{\Omega}(\nabla u+\nabla w)^{T}\pmb{K} \nabla v \ dx = \int_{\Omega}Fv \ dx -\int_{\partial\Omega}\pmb{K}\nabla (u+w)\cdot \pmb{n}v \ dx .
	\end{equation}
	Using the linearity of $a(\cdot,\cdot)$ and inserting boundary conditions we get:
	\begin{equation}\label{eq:inhomogenous poisson weak}
		a(u,v) = b(v)= \int_{\Omega} Fv \ dx - \int_{\Omega}(\nabla w)^T\pmb{K} \nabla v \ dx - \int_{\Gamma_N} g_N v \ dx.
	\end{equation}
	Hence both Dirichlet and Neumann boundary conditions are incorporated into the right hand side. For homogeneous Dirichlet boundary conditions, the second term on the right hand side of \eqref{eq:inhomogenous poisson weak} vanishes. 
	
	\subsection*{Existence and uniqueness}
	\addcontentsline{toc}{subsection}{Existence and uniqueness}
	We still need to show that \eqref{eq:inhomogenous poisson weak} has an unique solution.
	First we define some important properties that a variational problem should have in order to have a unique solution. Let $(V,\left \| \cdot \right \|_V)$ be a Hilbert space.
	\begin{definition} Let $a(\cdot,\cdot):V\times V \rightarrow \mathbb{R}$ be a \emph{bi linear form}. We say that:
			\begin{itemize}
			\item $a(\cdot,\cdot)$ is \textbf{coercive with respect to }$V$, or \textbf{elliptic} if there exists a constant $C_c\in \mathbb{R}$ such that $C_c\left \| u \right \|_V^2 \leq a(u,u) \ \forall u \in V$
			\item $a(\cdot,\cdot)$ is \textbf{bounded} or \textbf{continuous} if there exists a constant $C_B$ such that $|a(u,v)|\leq C_B\left \| u \right \|_V\left \| v \right \|_V \ \forall u,v \in V$
			\end{itemize}
	\end{definition}
	To use this to prove existence and uniqueness, we must first state some important results about the underlying space $V$. The following theory can be found in it's entirety in chapter one-four of Cheney \cite{Cheney}
	\begin{theorem}\label{th:decomposition of hilbert}
		If $Y$ is a closed subspace of a Hilbert space $X$, then $X = Y\otimes Y^{\bot}$ \\
		Where $Y^{\bot} = \left \{ \left. x\in X: \left \langle x,y \right \rangle=0 \ \forall y \in Y \right \} \right.$ is orthogonal complement.\\ That is: an element in $X$ can always be written as the sum of an element $Y$ and an element in $Y^{\bot}$.
	\end{theorem}
	\begin{theorem}[Riesz representation theorem]\label{th:riesz representation}
		Every continuous linear functional defined on a Hilbert space $X$ can be written $x\rightarrow \left \langle x,v \right \rangle$ for a uniquely determined $v \in X$.
	\end{theorem}
	\begin{proof}
		Let $\phi \in X'$, define $Y = \left \{ x\in X:\phi (x)=0 \right \}$ to be the null space of $\phi$. Take a non-zero vector in the orthogonal complement $u\in Y^{\bot}$ such that $\phi (u)=1$, (if this does not exist then $X=Y$ and $\phi (x) = \left \langle x, 0\right \rangle$, this is ensured by theorem \ref{th:decomposition of hilbert}). Now we can write every vector in $X$ as a linear combination of a vector in $Y$ and the vector $u$. $x = x-\phi (x) u + \phi(x) u$ for any $x \in X$. Using this, we can find an expression for the inner product of $x$ with a scaled version of $u$ \\
		$\left \langle x,\frac{u}{\left \| u \right \|^2} \right \rangle  = \left \langle x-\phi (x)u,\frac{u}{\left \| u \right \|^2} \right \rangle + \left \langle \phi (x)u,\frac{u}{\left \| u \right \|^2} \right \rangle $.
		The first part of the sum vanishes as $x - \phi (u)x \in Y$. So we end up with \\
		$\left \langle x,\frac{u}{\left \| u \right \|} \right \rangle  = \phi (x)\frac{\left \langle u,u\right \rangle}{\left \| u \right \|^2} = \phi (x)$ \\
	\end{proof}
	\begin{theorem}[Banach fixed-point theorem]\label{th:Banach}
		Let $X$ be a Banach space and $F:X\rightarrow X$ an operator where $\left \|Fx-Fy\right \|_X\leq \theta \left \| x-y \right\|_X$ for some $\theta \in (0,1)$, we call this a \textbf{contraction}.\\
		Then for all $x \in X$ the sequence $[x,Fx,F^2x,...]$ converges to a point $x^* \in X$ called the fixed point of $F$.
	\end{theorem}
	See page 177 of \cite{Cheney} for a proof.
	\begin{theorem}[Lax Milgram]\label{th:lax milgram}
		Suppose $a(\cdot,\cdot):V \times V \rightarrow \mathbb{R}$ is a bi linear, bounded and coercive form and that $b(\cdot): V \rightarrow \mathbb{R}$ is a bounded, linear functional. Then the variational problem has an unique solution $u$, such that
		\begin{equation}\label{eq:lax milgram}
			a(u,v)=b(v)
		\end{equation}
		for all $v \in V$.
	\end{theorem}
	\begin{remark}
		If $a(\cdot,\cdot)$ also is symmetric, and defines an inner product on $V$ giving a complete space. We can use Riesz representation theorem \ref{th:riesz representation} to show that it has an unique solution.
	\end{remark}
	\begin{proof}[proof of Lax Milgram theorem \ref{th:lax milgram}]
		$ $\\
		For each $w$ denote the map $a(w,v) = a_w(v)$, this is a linear continuous functional, this follows from the assumptions on $a$. By Riesz representation theorem \ref{th:riesz representation} $a_w(\cdot)$ uniquely determines a vector $Aw \in V$ such that $a_w(v) = \left \langle Aw,v \right \rangle$. The map
		\begin{equation*}
			\begin{gathered}
				A:V\rightarrow V \\
				w \mapsto Aw
			\end{gathered}
		\end{equation*}
		\begin{itemize}
			\item 		Is linear: $\left \langle A(x+y),v  \right \rangle = a_{x+y}(v) = a(x+y,v) = a_x(v)+a_y(v) = \left \langle Ax,v \right \rangle+\left \langle Ay,v \right \rangle$. Since this holds for all $v \in V$, we have $A(x+y)=Ax + Ay$.
			\item Is bounded: $\left \| Ax \right \|=\left \| a_x \right \| = \sup \left \{ a(x,v):\left \| v \right \|=1 \right \} \leq C_B \left \| x \right \|$.
		\end{itemize}
		We can also use Riesz representation theorem on the right hand side: $b(\cdot)=\left \langle f,\cdot \right \rangle$. Now we have a reformulation of \eqref{eq:lax milgram}:\\
		find $u$ such that
		\begin{equation}\label{eq:operator equation}
			Au = f.
		\end{equation}
		Now we need to show that \eqref{eq:operator equation} has an unique solution, and for that we need the Banach fixpoint theorem. Let $\epsilon > 0$, we define the operator 
		\begin{equation*}
			\begin{aligned}
				T:V &\rightarrow V \\
				u &\mapsto u-\epsilon (Au-f).
			\end{aligned}
		\end{equation*}
		If $T$ has a fixed point $u^*$, then $u^*-\epsilon(Au^*-f)=u^* \Rightarrow Au^* =f$ and we have solved \eqref{eq:operator equation} and proved the theorem. We just need to show that $T$ is a contraction.
		\begin{equation*}
			\left \| Tu_1 - Tu_2 \right \|^2 = \left \| u-\epsilon(Au) \right \|^2 
		\end{equation*}
		Where $u = u_1 - u_2$, here we used the linearity of $A$.
		\begin{equation*}
			=\left \| u \right \|^2 - 2 \epsilon \left \langle u,Au \right \rangle + \epsilon^2 \left \langle Au,Au \right\rangle
		\end{equation*}
		Now we can use that $a(u,u)=\left \langle Au,u \right \rangle$.\\
		And that $\left \langle Au,Au \right \rangle = a_u(Au) = a(u,Au)$ 
		\begin{equation*}
			=\left \| u \right \|^2 - 2\epsilon a(u,u) + \epsilon^2 a(u,Au)
		\end{equation*}
		Now we can use the coercivity and boundedness of $a(\cdot,\cdot)$. We also use the boundedness of $A$
		\begin{equation*}
			\leq \left \|u  \right \|^2 -2\epsilon C_c \left \| u \right \|^2 + \epsilon^2 C_B^2 \left \|u  \right \|^2
		\end{equation*}
		So now we have the inequality
		\begin{equation*}
			\left \| Tu_1 -Tu_2 \right \|^2 \leq \left \| u_1 - u_2 \right \|^2 (1-2\epsilon + \epsilon^2)
		\end{equation*}
		We can choose $\epsilon$ such that $T$ becomes a contraction.
		$\epsilon < \frac{2 C_c}{C_b^2} \Rightarrow (1-2\epsilon + \epsilon^2)<1$
	\end{proof}
	\begin{remark}\label{rm:stability}
		The solution, $u$ to our bi linear problem depends on the data $b(\cdot)$. To see this we use the coercivity:
		\begin{equation*}
			\left \| u \right \|^2 \leq \frac{a(u,u)}{C_c} = \frac{b(u)}{C_c}
		\end{equation*}
		And note that $b(\cdot)$ is a bounded functional:
		\begin{equation*}
			\Rightarrow \left \| u \right \| \leq \frac{b(u)}{C_c \left \|u\right \|} \leq \frac{\left \| b \right \|_{V'}}{C_c}
		\end{equation*}
	\end{remark}
	Now we have proved that \eqref{eq:variational problem} has an unique solution for suitable $a$ and $b$. The variational form of poisson equation \eqref{eq:variational poisson} satisfies this:
	\begin{example}[Well posedness of variational form of Poisson equation]
		Let $a(u,v) = \int_{\Omega}\nabla u \cdot \nabla v \ dx$. Then $a$ is:
		\begin{itemize}
			\item \textbf{Coercive} with respect to $\left \| \cdot \right \|_{H_0^1}$
			\begin{equation*}
				\begin{gathered}
					\left \| u \right \|^2_{H_0^1} = \left \| u \right \|^2_{L^2} + \sum_{|\overline{\alpha}|=1} \left \| D^{\overline{\alpha}} u \right \|^2_{L^2}\\
					=\left \|u\right \|^2_{L^2} + a(u,u) \\
					\leq (C_{\Omega} + 1)a(u,u)
				\end{gathered}
			\end{equation*}
			Where we used the \textbf{Poincare inequality} in the last step.
			\item \textbf{Bounded} with respect to $\left \| \cdot \right \|_{H_0^1}$
			\begin{equation*}
				\begin{gathered}
					|a(u,v)|\leq |\int_{\Omega}\nabla u \cdot \nabla v dx| \leq \int_{\Omega} |\nabla u \cdot \nabla v| dx \\
					\int_{\Omega} |\sum_{|\overline{\alpha}|=|}D^{\overline{\alpha}}u D^{\overline{\alpha}}v|dx=\sum_{|\overline{\alpha}|=|} \left \| D^{\overline{\alpha}}u D^{\overline{\alpha}}v \right \|_{L^1} \leq \sum_{|\overline{\alpha}|=|} \left \| D^{\overline{\alpha}}u \right \|_{L^2} \left \| D^{\overline{\alpha}}v \right \|_{L^2} \\
					\leq \left \|u \right \|_{H_0^1} \left \| v \right \|_{H_0^1}
				\end{gathered}
			\end{equation*}
			Where we used the \textbf{Cauchy Swarchz inequality} on the second line.
		\end{itemize}
		We also see that $b$ is in the dual space of $H_0^1$ if for example $f\in L^2(\Omega)$:
		\begin{equation*}
			\begin{gathered}
			|b(v)| = |\int_{\Omega} fv dx | \leq \left \|f \right \|_{L^2} \left \| v \right \|_{L^2} \\
			\Rightarrow \left |\ b \right \|_{H_0^{1'}} = \sup\left \{ \frac{|b(v)|}{\left \| v \right \|} \right \} \leq \left \| f \right \|_{L^2}
			\end{gathered}
		\end{equation*}
		Hence \eqref{eq:variational poisson} is well posed and we get a solution $u \in H_0^1(\Omega)$.
	\end{example}

	\subsection*{Galerkin FEM} \label{galerkin_fem}
	\addcontentsline{toc}{subsection}{Galerkin FEM}
	Now we want to discretize the variational equation \eqref{eq:variational problem}. We do this by replacing the test space $V$ by a finite dimensional subspace $V_h$, this is called the \emph{Galerkin method}. The discretization now reads: Find $u \in V_h$ such that 
	\begin{equation}\label{eq:galerkin}
		\begin{gathered}
			a(u,v_h) = b(v_h) 
		\end{gathered}
	\end{equation}
	for all $v_h$ in $V_h$.
	Since $a$ is bi linear and $b$ is linear, it is easy to see that if \eqref{eq:galerkin} holds for the basis functions of $V_h$, it holds for all elements in $V_h$. In the \emph{finite element method}, the finite dimensional subspace are determined by the \emph{triangulation}. In this thesis, we only consider problems in two spatial dimensions, so let $\Omega \subset \mathbb{R}^2$. 
	\begin{definition}[two dimensional triangulation, page 56 of Knaber \cite{Knabner}]
		Let $\tau_h$ be a partition $\Omega$ into closed trinagles $K$ including the boundary $\partial \Omega$, with the following properties
		\begin{itemize}
			\item[\textbf{(T1)}] $\overline{\Omega} = \bigcup_{K\in \tau_h}K$ .
			\item[\textbf{(T2)}] For $K$, $K' \in \tau_h$, $K \neq K'$ \begin{equation*}
				int(K) \bigcap int(K')=\emptyset,
			\end{equation*} 
			where $int(K)$ denotes the interior of $K$.
			\item[\textbf{(T3)}] If $K\neq K'$, but $K\bigcap K' \neq \emptyset$, then $K\bigcap K'$ is either a point or a common edge of $K$ and $K'$.
			
		\end{itemize}
	\end{definition}
	The above definition sets some rules on how we can divide our domain into triangles, often called elements.
	Now that we have a triangulation, we can now define our finite dimensional subspace, $V_h$.
	\begin{definition}[Linear ansatz space]\label{def:linear ansatz}
		Let $\mathcal{P}_1(K)$ be the space of polynomials of one degree in two variables on $K\subset \mathbb{R}^2$, then the ansatz space
		\begin{equation*}
			V_h = \left \{ u_h \in C(\overline{\Omega}) : u_{h|K} \in \mathcal{P}_1(K) \ \forall K \in \tau_h, u|_{\Gamma_D} = 0  \right \}
		\end{equation*}
		Are the space of piecewise linear functions on each $K$
	\end{definition}
	\begin{remark}
	Our local ansatz space $P_K = \left \{ v|_K:v\in V_h \right \}$ is such that $P_K = P_1 \subset H^1(K) \bigcap C(K)$. This together with \textbf{(T3)}, which ensures continuity between elements, makes $V_h$ a \emph{conformal finite element method}, ie $V_h \subset V = H_0^1$
	\end{remark}
	\begin{remark}[Nodes]
		We will refer to the corners of the triangles in $\tau_h$ as nodes. For more advanced element types one can nodes also on the edges or interiors of the triangles.
	\end{remark}
	\begin{remark}
		In general, finite elements are defined by an element $K(\in \tau_h)$, the local ansatz space $P_K$ and degrees of freedom $\Sigma_K$. In all Lagrange finite element methods $\Sigma_K$ is the evaluation on functions in $P_K$ at the nodes of the element.
	\end{remark}

	A choice of basis for $V_h$ would then be the hat functions.  Let $\phi_i$ be the basis function corresponding to the node $x_i$, it is defined by:
	\begin{equation*}
		\phi_i(x_j) = \delta_{ij}, \ \ \phi_i \in V_h.
	\end{equation*}
	There are no basis functions defined for the nodes at the Dirichlet boundary.
	\begin{figure}[H]
		\centering
		\includegraphics[width=0.8\textwidth]{hat_function_python_plot_2.pdf}
		\caption{A hat function .}
		\label{fig:hat1}
	\end{figure}
	Now, we demonstrate how the method works in practice. We seek a solution $u_h \in V_h$. Write this in terms of the basis functions: $u_h = \sum_{i=1}^n u_i^* \phi_i$. Now, \eqref{eq:galerkin} can be written as an equation with a solution vector with real coefficients: Find $\pmb{u}^*$ in $\mathbb{R}^n$ such that
	\begin{equation}\label{eq:fem system}
		\begin{gathered}
			\sum_{i=1}^n u_i^*  a(\phi_i,\phi_j) = b(\phi_j).
		\end{gathered}
	\end{equation}
	So we get a system of linear equations $A\pmb{u}^* = \pmb{b}$, where we have one equation for each interior node. If we solve \eqref{eq:variational poisson}, our variatonal problem, and also matrix, will be symmetric. The matrix is then often called a \emph{stiffness matrix}. These names originated from mechanics and structural analysis, where the solution represents displacement and the force function represents load. The stiffness matrix is also sparse, which is a very important property when designing algorithms to solve it.\par
	With the setup described in this subsection, the degrees of freedom are the same as the dimension of $V_h$. If we in definition \ref{def:linear ansatz} instead had chosen a space of quadratic polynomials on each element, we hade gained three degrees of freedom on each element. In this thesis we focus on linear finite elements because we do not gain anything from increasing regularity, as the solutions are not expected to be very regular. 
	\subsection*{Implementation}
	\addcontentsline{toc}{subsection}{Implementation}
	In this subsection we explain the most important parts of the algorithm for discretizing elliptic PDE's with linear triangular elements. We consider the homogenous elliptic model problem \eqref{eq:variational poisson} in two dimensions with $\pmb{K} = \pmb{I}$. The procedure goes as follows:
	\begin{enumerate}
		\item Make a triangulation of the domain. This can be done in a number of different ways, see chapter 4 of Knabner \cite{Knabner}. If we have $N$ nodes, our triangulation would be stored as a $N \times 2$ array of floats, being the coordinates of the nodes. And a $E\times 3$ array of ints beieng the elements, where each entry is the index of a coordinate in the coordinate matrix, E is the number of elements.
		\item Allocate space for the $N \times N$ stiffness matrix $\pmb{A}$ and the $N \times 1$ source vector $\pmb{b}$.
		\item Define the basis functions on a reference element, this is also called the shape functions, see figure \ref{fig:reference element} and \eqref{eq:shape functions}. Also compute the gradients of the shape functions. 
		\begin{equation}
			\begin{gathered}\label{eq:shape functions}
				N_1(x,y) = 1-x-y\\
				N_2(x,y) = x\\
				N_3(x,y) = y
			\end{gathered}
		\end{equation}
		\begin{figure}[H]
			\centering
			\includegraphics[width=0.85\textwidth]{reference element.pdf}
			\caption{The map $F$ from element $K$ to the reference element $\hat{K}$.}
			\label{fig:reference element}
		\end{figure}
		\item Loop trough the elements. For each element $K$ compute the affine linear map that maps it to the reference element. That means we want to find $B\in \mathbb{R}^{2\times 2}$ and $d\in \mathbb{R}^2$ such that 
		\begin{equation}
			\begin{aligned}
				F: K &\rightarrow \hat{K}\\
				x &\mapsto B x + d
			\end{aligned}
		\end{equation}
		To achieve this we set up a system of equations inspired by figure \ref{fig:reference element}
		\begin{gather}\label{eq:find_Bd}
			\begin{pmatrix}
				x_1 & y_1 & 1\\ 
				x_2 & y_2 & 1\\ 
				x_3 & y_3 & 1
			\end{pmatrix}\begin{pmatrix}
				b_{1,1} & b_{2,1}\\ 
				b_{1,2} & b_{2,2}\\ 
				d_1 & d_2
			\end{pmatrix}=
			\begin{pmatrix}
				0 &0 \\ 
				1& 0\\ 
				0 &1 
			\end{pmatrix}
		\end{gather}
		So for each element we solve \eqref{eq:find_Bd} for $B$ and $d$, that means computing an inverse of a three by three matrix and a matrix product. Note that this only needs to be done once and could be done in a preprocessing step. \par
		Now that we have $T$, we do the following on the element:
		\begin{enumerate}
					\item Use the map and the shape functions to evaluate $a(\phi_i,\phi_j)|_K$  for $1\leq i,j \leq 3$. Note that for $u: K \rightarrow \mathbb{R}$
			\begin{equation}
				\nabla^T_{\hat{x}} u(F^{-1}(\hat{x})) = \nabla^T_{x}u(F^{-1}(\hat{x}))\nabla^T_{\hat{x}} F^{-1}(\hat{x}) =\nabla^T_{x}u(F^{-1}(\hat{x})) B^{-1}
			\end{equation}
			This gives an expression for the derivative on an element expressed as a derivative in the reference element coordinate
			\begin{equation}
				\nabla_{x}u(F^{-1}(\hat{x})) = B^T \nabla_{\hat{x}} u(F^{-1}(\hat{x}))
			\end{equation}
			Now we can compute the product of the gradients of the bassis functions on an element.
			\begin{equation}\label{eq:elementgradient}
				\begin{aligned}
					a(\phi_i,\phi_j)|_K &= \int_K (\nabla \phi_i)^T \nabla \phi_j dx\\
					&= \int_{\hat{K}} (\nabla_x \phi_i(F^{-1}(\hat{x})))^T\nabla_x \phi_j(F^{-1}(\hat{x})) |\text{Det}(J(F^{-1}))|d\hat{x}\\
					&=\int_{\hat{K}}(B^T \nabla_{\hat{x}}\phi_i (F^{-1}(\hat{x})))^TB^T \nabla_{\hat{x}}\phi_j (F^{-1}(\hat{x})) |\text{Det}(B^{-1})|d\hat{x}\\
					&=\int_{\hat{K}} (\nabla_{\hat{x}}N_i(\hat{x}))^TB^TB\nabla_{\hat{x}} N_j(\hat{x}) |\text{Det}(B^{-1})|d\hat{x}\\
					&= \frac{1}{2} (\nabla_{\hat{x}}N_i(\hat{x}))^TB^TB\nabla_{\hat{x}} N_j(\hat{x}) \frac{1}{|\text{Det}(B)|}
				\end{aligned}
			\end{equation}
			So for each element we evaluate the last line of \eqref{eq:elementgradient} for all(9) combinations of $i$ and $j$ on the element 
			and add this to $\pmb{A}_{i,j}$. This approach is called \emph{element-based assembling}, and $\pmb{A}_{i,j} = \sum_{K\in \mathcal{N}(i)} a(\phi_i,\phi_j)|_K$, where $\mathcal{N}(i)$ is the set of all elements that contain node $i$.
			\item In almost the same way we compute $b(\phi_i)|_K$ and add this to $\pmb{b}_i$. As in \eqref{eq:elementgradient} we compute the integral on the reference element:
			\begin{equation}
				\begin{aligned}
					b(\phi_i)|_K &= \int_{\hat{K}} f(F^{-1}(\hat{x})) \phi_i(F^{-1}(\hat{x})) \frac{1}{\text{Det}(B)}d\hat{x}\\
					&= \int_{\hat{K}}\hat{f}(\hat{x}) N_i(F^{-1}(\hat{x}))\frac{1}{\text{Det}(B)}d\hat{x}\\
					&\approx \frac{1}{\text{Det}(B)} \sum_k \omega_k \hat{f}(\hat{p}_k) N_i(\hat{p}_k)
				\end{aligned}
			\end{equation}
			Where $\hat{f}:= f(F^{-1}(\hat{x}))$ and $\left \{ (\omega_k,\hat{p}_k) \right \}_k$ defines a \emph{quadrature rule}. We will see later that this quadrature rule can be chosen in different ways, for higher order finite elements this may even affect the convergenec behauviour. 
		\end{enumerate}

		\item Loop through the nodes $x_j$ at the boundary and set $\pmb{A}_{j,i}=\delta_{ij}$, $b_j = 0$

	\end{enumerate}
	\begin{remark}
		If we have inhomogeneous Dirichlet boundary conditions this is in practice done the same way as in the homogenous case, eliminating the degrees of freedom on the boundary. For Neumann conditions one has to evaluate integrals along the boundary as in \eqref{eq:inhomogenous poisson weak}, using one-dimensional elements.
	\end{remark}
	\subsection*{Convergence}
	\addcontentsline{toc}{subsection}{Convergence}
	
	In this subsection, we review the most important concepts in studying the convergence fo FEM, for a detailed discussion see \cite{Knabner}.
	The starting point of convergence estimates for the finite element method already described are \textbf{CÃ¨a's lemma}. 
	\begin{theorem}
		Let $u$ solve the variational problem \eqref{eq:variational problem} and $u_h$ solve the corresponding Galerkin approximation \eqref{eq:galerkin}, where the bi linear form $a$ is bounded and coercive. Then we have:
		\begin{equation}
			\left \| u-u_h \right \|_V \leq \frac{C_b}{C_c}\text{min} \left \{ \left \| u-v_h \right \|: \ v_h \in V_h \right \}.
		\end{equation}
		
	\end{theorem}
	\begin{proof}
		By the coercivity and linearity of $a(\cdot,\cdot)$ we have:
		\begin{equation*}
			C_c \left \| u-u_h \right \|^2_V \leq a(u-u_h,u-u_h) = a(u-u_h,u-v_h) + a(u-u_h, v_h - u_h).
		\end{equation*}
		The last term equals zero, since both $u$ and $u_h$ solves the variational problem in $V_h$: $v_h-u_h = v \in V_h$ and $a(u-u_h,v) = a(u,v)-a(u_h,v) = b(v)-b(v) = 0$, this is called \emph{Galerkin orthogality}. Hence we only need to use the boundedness of $a(\cdot,\cdot)$:
		\begin{equation*}
			C_c \left \| u-u_h \right \|^2_V \leq a(u-u_h,u-u_h) \leq C_b \left \| u-u_h \right \|_V \left \| u-v_h \right \|_V.
		\end{equation*}
		We divide by $C_c$ and $\left \| u-u_h \right \|_V$ and take the infimum over $v_h \in V_h$:
		\begin{equation*}
			\left \| u-u_h \right \|_V \leq \frac{C_b}{C_c} \text{inf} \left \{ \left \| u-v_h \right \|_V: v_h \in V_h \right \}.
		\end{equation*}
		By (Cheney \cite{Cheney}, page 64, theorem 2), as $V_h$ is closed and convex subspace of a Hilbert space, there exist an unique element of $V_h$ closest to $u$ and minimum is attained.  
	\end{proof}
	Hence the solution to Galerkin problem is the best in the subspace $V_h$ up to a constant. We can therefore study convergence rate estimates for a suitable comparison element in $V_h$. In one dimension it is easy to picture what this comparison element might be, see figure \ref{fig:1dinterpolation}. A direct proof with techniques from calculus is possible in this case.\\
	\begin{figure}[H]
		\centering
		\includegraphics[width=0.7\textwidth]{interpolation.pdf}
		\caption{The unique linear interpolation of a function in one dimension.}
		\label{fig:1dinterpolation}
	\end{figure}
	The idea for more dimensions are the same, to be precise we define the interolation operator.
	\begin{definition}[Global interpolation operator]		\label{def:global_interpolator}
		\begin{gather*}
			I_h:C(\overline{\Omega}) \rightarrow V_h \\
			v \mapsto \sum_{i}v(n_i) \phi_i
		\end{gather*} 
	Where $\left\{ n_i\right \}_i$ are the nodes and $\left\{ \phi_i\right \}_i$ the corresponding basis functions.

	\end{definition}
	\begin{remark}
		The global interpolator operator \ref{def:global_interpolator} maps from continuous functions, so we need to make sure our solution is continuous. By the Sobolev embedding theorem, (Evans \cite{evans10},page 286) we are okay if our space dimension is below three and $u \in H^k(\Omega)$ for $k\geq 2$.
	\end{remark}
	Hence, in the setting of the model problem \eqref{eq:variational poisson}, we hope to reach an estimate on the form
	\begin{equation}\label{eq:energy norm estimate}
		\left \| u-u_h \right \|_{1} \leq C \left \| u-I_h(u) \right \|_{1}\leq C^* h^{k}|u|_{k+1}
	\end{equation}
	Where $h$ is the maximum diameter of the elements in the triangulation, and $k$ is the polynomial degree on the ansatz space.
	This bound is indeed attainable if we make sure the triangles in our triangulation have maximum angle less than $\pi$.
	In chapter 3.4 of Knabner \cite{Knabner}, there is a detailed proof of \eqref{eq:energy norm estimate}.\\
	Note that this means that our linear finite element method has a linear convergence in the $\left \| \cdot \right \|_1$ norm, if our variational problem admits a solution with sufficient regularity. We tie these observations together in a theorem:
	\begin{theorem}[energy norm estimate]\label{th:energy error estimate}
		Consider a finite element discretization as described by \eqref{eq:fem system} in $\mathbb{R}^d$ for $d\leq 3$ on a family of triangulations with an uniform upper bound on the maximal angle. Suppose we have a linear ansatz space as in \ref{def:linear ansatz}, then
		\begin{equation}
			\left \| u-u_h \right \|_{1}\leq C h|u|_{2}.
		\end{equation}
	\end{theorem}
	Often we are happy with a convergence rate estimate in the $\left \| \cdot \right \|_0$ norm, which do not meassure an error in the approximation of the derivative. We then expect a better convergence rate, as can be shown by the \emph{duality trick}. We consider the dual prbolem of our variational problem \eqref{eq:variational poisson}: $a(v,u_f) = \left \langle f,v\right \rangle_0$, and assume some uniqueness and stability of the solution $u_f$ of this. 
	\begin{theorem}[$L^2$ estimate]
		Suppose the situation of theorem \ref{th:energy error estimate} and assume there exist an unique solution to the adjoint problem with $| u_f| \leq C \left \|f \right \|_0$, then there exist a constant $C^*$ such that:
		\begin{equation}
			\left \| u - u_h \right \|_0 \leq C^* h \left \| u- u_h \right \|_1.
		\end{equation}
	\end{theorem}
	See \cite{Knabner} for a proof. When it comes to the assumption on the dual problem, this is satisfied for our elliptic model problem \ref{eq:poisson}. If we put the last two theorems together we obtian quadratic convergence in the $L^2$ norm
	\begin{remark}
		In this chapter we have only discussed the convergence behaviour of the solution to the Galerkin problem \eqref{eq:galerkin}. In practice, one often only solves this approximately. For example the term  $b(v_h)=\int_{\Omega}fv_h \ dx$ is impossible to evaluate exactly for most source terms $f$. We will later see error estimates with this taken into account.
	\end{remark}
	\subsection*{Condition Number and Minimum Principle}
	\addcontentsline{toc}{subsection}{Stability}
	When simulating two phase flow in porous media, or groundwater flow, one often needs to solve elliptic problems. We will state a property for the solution of these problems, that can have a big negative impact if not respected by a discretization.\par For a source term $F$ and a symmetric positive definite matrix $\pmb{K}$, let
	\begin{equation}\label{eq:elliptic min}
			\nabla \cdot (-\pmb{K}\nabla p) = F 	
	\end{equation}
	in some open domain $D$.
	The solution to elliptic PDE's like the one above, with appropriate boundary conditions, satisfy the property:
	\begin{prop}
		Let $p$ solve \eqref{eq:elliptic min} in $D$, and suppose $F\geq 0$ in $D$. Then if there exists a point $x_0 \in D$ such that $p(x_0)<p(x)$ for all other $x$ in $D$, $p$ is constant in $\Omega$.
	\end{prop}
	The physical interpretation of this is that if \eqref{eq:elliptic min} models the pressure in a domain with positive pressure along the boundary and no sinks, the solution never admits negative pressure inside the domain. If the pressure is coupled with saturation, like in the setting of Richards' equation \eqref{eq:richards}, one could produce air if the pressure where to drop below zero. 
	\todo[inline]{Write more about stability properties of FEM, so that one later can compare with stability properties of the FVM methods.}
	\section*{Finite Volume Method}
	\addcontentsline{toc}{section}{Finite Volume Method}

		Finite volume methods are designed such that the conservation law we solve hold everywhere in the domain. Consider our elliptic model problem \eqref{eq:poisson}, first we divide our domain $\Omega$ into convex quadrilaterals(control volumes, cells), $\left \{ \Omega_i \right \}_i$. Then we integrate our equation over $\Omega_i$ and use the divergence theorem:
	\begin{equation}\label{eq:fvm1}
		\int_{\Omega_i} -\nabla \cdot \pmb{K} \nabla u dx = -\int_{\partial \Omega_i} \pmb{K}\nabla u \cdot \pmb{\hat{n}} ds = \int_{\Omega_i} F dx
	\end{equation}
	The above equation equates the fluxes trough the boundary of a control volume, with the source or sinks inside the control volume. The finite volume methods are discrete versions of this. The main idea is to approximate the normal flux trough edge $j$ of $\partial \Omega_i$
	\begin{equation}
		f_{i,j} =-\int_{\partial \Omega_{i,j}} \pmb{K}\nabla u \cdot \pmb{\hat{n}} ds
	\end{equation}
	
	by a linear combination of $u_i$ at neghbouring cell centers. 
	\begin{equation}
		\tilde{f}_{i,j} = \sum_{k}t_{j,k}u_k
	\end{equation}
	Where the \emph{transmissibility } $t_{j,k}$ has the property $\sum_k t_{j,k} = 0$. 
	We also approximate the integral on the right side by evaluating $F$ at the cell center and multiply by the area of $\Omega_i$. We then end up with a system of equations
	\begin{equation}\label{eq:fvm system}
		\sum_{j=1}^4 \tilde{f}_{i,j} = |\Omega_i|F(x_i)
	\end{equation}
	The system of equations \eqref{eq:fvm system} ensures local mass conservation. We will discuss different ways of constructing the transmissibility coefficients, as they result in very different discretizations.
	\par
	When it comes to boundary conditions, this is usually straightforward for Neumann boundaries. Especially no-flow boundary conditions, where one just creates a strip of cells outside the boundary with zero permeability. One then just use the same algorithm everywhere. Dirichlet boundary conditions often requires more special care. If one however knows the solution somewhere outside the domain, one could make a strip of cells outside the boundary where the potential values are known, this is known as ghost Dirichlet boundary conditions. We will focus on discretizing the interior of the domain in the following sub sections.
	\subsection*{Two point flux approximation}
	\addcontentsline{toc}{subsection}{Two point flux approximation}The simplest way of constructing $t_{j,k}$ is also the most popular in the industry. As the name suggests, we only use the function value at two points, $x_{j,0}$ and $x_{j,1}$, to compute the numerical flux $\tilde{f}_j$.
	\begin{figure}[H]
		\centering
		\includegraphics[width=0.5\textwidth]{two point.pdf}
		\caption{The two point flux approximation(TPFA) setup.}
		\label{fig:tpfa control volume}
	\end{figure}
	Let $\pmb{v}_1$ be the vector from cell center $x_0$ to the midpoint of the edge between the cells, $\overline{x}$. Then we approximate the flux between the cells by
	
	\begin{equation}
		f_0=-\int_{\partial \Omega} \hat{\pmb{n}}^T \pmb{K}_0  \frac{\pmb{v}_0}{\left \| \pmb{v}_0 \right \|} (u(\overline{x})-u(x_0))ds
	\end{equation}
	
	or as
	
	\begin{equation}
		f_1 = -\int_{\partial \Omega} \hat{\pmb{n}}^T \pmb{K}_1  \frac{\pmb{v}_1}{\left \| \pmb{v}_1 \right \|} (u(x_1)-u(\overline{x}))ds
	\end{equation}	
	
	where $\hat{n}$ is the normal vector to edge between the cells.
	Because we require flux continuity we have that 
	\begin{equation}
		f_0 = f_1 = t_0 u(x_0) + t_1 u(x_1)
	\end{equation}
	where, as before, $t_0 + t_1 = 0 \Rightarrow t_0 = -t_1$. We now have three equations and three unknowns, $u(\overline{x})$, $t_0$ and $t_1$. To simplify, we introduce the quantity $T_i := \int_{\partial \Omega} \hat{\pmb{n}}^T \pmb{K}_i  \frac{\pmb{v}_i}{\left \| \pmb{v}_i \right \|} $ to represent the cell transmissivity. So first we solve for $u(\overline{x})$:
	\begin{equation}
		T_0(u(\overline{x})-u(x_0)) = T_1(u(x_1)-u(\overline{x})) \Rightarrow u(\overline{x}) = \frac{T_0 u(x_0) + T_1 u(x_1)}{T_0 + T_1}.
	\end{equation}
	Next we insert this into the expression for $f_0$:
	\begin{equation}
		\begin{aligned}
			f_0 =& -T_0(u(\overline{x})-u(x_0)) \\
			=& -T_0(\frac{T_0 u(x_0) + T_1 u(x_1)}{T_0 + T_1} - u(x_0))\\
			=& -T_0(\frac{T_0 u(x_0) + T_1 u(x_1) - u(x_0)T_0 - u(x_0)T_1}{T_0 + T_1}) \\
			=& -T_0(\frac{ T_1 u(x_1)  - u(x_0)T_1}{T_0 + T_1})\\
			=& \frac{u(x_0)-u(x_1)}{\frac{1}{T_1} + \frac{1}{T_0}}.
		\end{aligned}
	\end{equation}
	Now, we have solved the equations for the transmissivity coefficients:
	\begin{equation}\label{eq:harmonic mean}
		\begin{aligned}
			f_0 &= t_0 u(x_0) + t_1 u(x_1) \\
			\frac{u(x_0)-u(x_1)}{\frac{1}{T_1} + \frac{1}{T_0}} &= t_0 u(x_0) + t_1 u(x_1) \\
			\Rightarrow t_0 &= \frac{1}{\frac{1}{T_1} + \frac{1}{T_0}}
		\end{aligned}
	\end{equation} 
	Hence, the transmissibility is the \emph{harmonic mean} of the local transmissivities. This discretization has the advantage of being fast to assemble and simple to code. It yields a pleasant five point stencil for two dimensional problems.  \par However there is one big disadvantage with two point flux approximation: Computing the flux with only two points is not consistent when the grid is not aligned with the principal directions of $\pmb{K}$. If our grid is aligned with $\pmb{K}$, we have that 
	\begin{equation}
		\pmb{n}_2 \cdot \pmb{K}\pmb{n}_1 = 0
	\end{equation}
	for a uniform parallelogram mesh with the normal vectors $n_1$ and $n_2$. We then call the grid \textbf{K-orthogonal}. 
	 In the setting of figure \ref{fig:tpfa control volume}, our grid would not be K-orthogonal as the control volumes are not a parallelograms. All meshes with orthogonal control volumes are K-orthogonal if the permeability is isotropic.
	 \todo[inline]{reference a figure showing the failed convergence of TPFA}
	\subsection*{O-method}
	\addcontentsline{toc}{subsection}{O-method}
	The O-method is a multi-point flux approximation method, these types of methods where developed to make control volume methods converge for grids that are not K-orthogonal. It is described in detail in  \cite{Aavatsmark2002}, I only give a brief introduction.
	\\
	Consider the control volumes in \ref{fig:dualmesh}.
	\begin{figure}[H]
		\centering
		\includegraphics{dualmesh.pdf}
		
		\caption{The solid lines are the control volumes, the dashed lines are the dual mesh connecting the cell centers, going trough the midpoints of each edge.}
		\label{fig:dualmesh}
	\end{figure}
	For each gridpoint, that means where four control volumes intersect, we consider an interaction region. This is the polygon drawn by the dualmesh around the gridpoint.
	\begin{figure}[H]
		\centering
		\includegraphics[width=0.6\textwidth]{Interaction region.pdf}
		\caption{The interaction region corresponding to cells $1,2,3,4$.}
		\label{fig:interactionregion}
	\end{figure}
	In each interaction region there are four half edges. Our goal is to obtain an expression 
	\begin{equation*}
		f_j = \int_{\partial \Omega_j}\hat{\pmb{n}_j}^T \pmb{K} \nabla u ds = \sum_{k=1}^4 t^{j,k} u^k \ \ j,k \in \left \{ 1,2,3,4 \right \}
	\end{equation*}
	for the flux through each half edge, where subscript $i$ denotes the half edges of the interaction region and $j$ denotes cell center potential values.
	\par
	We assume for now that the potential is linear in each of the four sub cells in the interaction region, figure  \ref{fig:interactionregion}. This gives $4\cdot 3 = 12$ degrees of freedom. The linear potential must of course equal the cell center values of the potential in the cell centers, this removes four degrees of freedom. We also require flux continuity on the four half edges in the interaction region, this removes an additional four degrees of freedom. The last four degrees of freedom are spent on potential continuity of the midpoints of the edges. 
	\par
	By these assumptions on flux and potential continuity, the linear potential in each sub cell is well defined given values at the cell center. We can now use this to compute the four by four matrix, $\pmb{T}=\left \{ t^{j,k} \right \}$,  of transmissibility coefficients  for each of the four half edges, see \cite{Aavatsmark2002} for the details. It involves inverting a four by four matrix with coefficients depending on the mesh and permeability. Finally we assemble the system of equations \eqref{eq:fvm system} with the transmissibility coefficients. Note that we write the flux over the $j$th edge of cell $i$, $\tilde{f}_{i,j}$ as the flux over the two half edges:
	\begin{equation*}
		\begin{aligned}
			\sum_{j=1}^4 (\tilde{f}_{i,j}^1 + \tilde{f}_{i,j}^2) &= |\Omega_i|F(x_i) \\
			\sum_{j=1}^4 (\sum_{k=1}^4 t^{j,k,1}_{i}u^k + \sum_{k=1}^4 t^{j,k,2}_{i}u^k)&= |\Omega_i|F(x_i).\\
		\end{aligned}
	\end{equation*}
	Next, we see that the interaction regions of the two half edges sharing same edge overlaps, so we get a six point flux stencil:
	\begin{equation*}
		\sum_{j=1}^4 \sum_{k=1}^6 \overline{t}^{j,k}_{i}u^k = |\Omega_i|F(x_i).
	\end{equation*}
	We can simplify this further and see that we get a nine point stencil:
	\begin{equation*}
		\sum_{k=1}^9 \hat{t}^{k}_{i,j}u^k = |\Omega_i|F(x_i).
	\end{equation*}
	The O-method is consistent for non K-orthogonal grids, and reduces to two point flux approximation when the grid is K-orthogonal.
	\par
	In \cite{nordbotten2020introduction}, Nordbotten and Keilegavlen describes a framework of MPFA methods where the O-method is a special case. They consider the problem of finding the four linear potential functions in each interaction region that minimizes the discontinuity across the edges. The discontinuity should be minimized given that the functions respect cell center potential values, that the flux models the constitute law and flux continuity. The O-method is then defined for some special cost function measuring the discontinuity. Other methods, with the potential continuity at other places than the edge midpoint, are also common.
	\par 
	With my implementation of MPFA-O method, one needs to assemble four, four by four, matrices. Compute the inverse of one of them, and do two matrix multiplications and one subtraction. All of this could be done in parallel. However, for my implementation, it slows matrix assembly down a lot compare to two point flux approximation. Another drawback of the O-method is the \emph{monotonicity} properties: One can risk having positive entries off the main diagonal of the discretization matrix for difficult meshes. For two point flux approximation this can obviously not be the case. Even for the linear finite element method, this issue is avoided if one imposes some maximum angle condition, see [Knabner,\cite{Knabner}] page 175. When solving for example the Richards' equation, violating the minimum principle can lead to air bubbles being formed spontaneously in the saturated region. For a discussion on monotonicity see \cite{10.1007/s00211-006-0060-z}.
	\subsection*{L-method}
	\addcontentsline{toc}{subsection}{L-method}
	\epigraph{The L-method is the Ferrari of discretization techniques for elliptic problems, while conformal finite elements is the Volvo.}{\textit{UIB professor}}
	As the O-method, the L-method is also a multipoint flux approximation method. It was introduced in \cite{https://doi.org/10.1002/num.20320}, where the authors demonstrate improved monotonicity properties with numerical experiments. This method is similar to the O-method, in that it goes trough the half edges and uses information from the same interaction regions. But instead of using four points for the flux across each half edge, we use three, with two half edges between them. \par
	As in the O-method, we assume linear potential in each cell, this gives us $3\cdot 3 = 9$ degrees of freedom. Three are eliminated because we respect the cell center value of the potential, this leaves six degrees of freedom. We use two, one at each edge, for flux continuity. The last four are used for potential continuity at the two edges. 
	\par
	We have two choices of flux stencil for each half edge, see figure \ref{fig:two choices}. We compute the transmissibility coefficients for both, then we choose the one "best" aligned with the flow: Let $t_1^i$ be the $i$th transmissibility coefficient of $T_1$, then
	\begin{equation}\label{eq:L-criterion}
		\begin{aligned}
			&\text{if} \ |t^1_1| < |t^2_2| \\
			&\text{choose} \ T_1 \ \text{else} \\
			&\text{choose} \ T_2.
		\end{aligned}
	\end{equation}
	\begin{figure}[H]
		\centering
		\begin{subfigure}[b]{0.4\textwidth}
			\centering
			\includegraphics[width=\textwidth]{left choice.pdf}
			\caption{$T_1$}
		\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.4\textwidth}
			\centering
			\includegraphics[width=\textwidth]{right choice.pdf}
			\caption{$T_2$}
			\label{fig:three sin x}
		\end{subfigure}
		\caption{The two choices of which cell centers to use for computing the flux over the half edge in red. We call the triangles spanned $T_1$ and $T_2$ for L-triangles.}
		\label{fig:two choices}
	\end{figure}
	A cheap intuition behind \eqref{eq:L-criterion} is that if $|t_1^1|<|t_2^2|$, it is more likely that $sgn(t_1^1) = sgn(t_1^4)$ and if not, $sgn(t_2^2) = sgn(t_2^3)$ is more likely. This is due to the fact that $\sum t^i = 0$. Choosing L-triangle as in \eqref{eq:L-criterion} increases the chances that we get the same sign of $t^i$ on the same side of the half edge, thus increasing the chance that we get a discretization matrix with no positive values off the main diagonal.  See \cite{https://doi.org/10.1002/fld.1926} for a more detailed geometric intuition of choosing L-triangle in the case of homogenous permeability. 
	\par 
	To compute transmissibility coefficients in a given L-triangle, we use the assumptions on flux and potential continuity, to construct a linear system. The coefficients depends on mesh and permeability in the three cells. In general, we need to solve two linear systems for each half edge, as there are always two choices. In the O-method it is enough to solve a linear system per four half edges.
	
	\par
		As with the O-method, we end up with a system assembled from the fluxes over the half edges:
	\begin{equation}
		\begin{aligned}
			\sum_{j=1}^4 (\tilde{f}_{i,j}^1 + \tilde{f}_{i,j}^2) &= |\Omega_i|F(x_i) \\
			\sum_{j=1}^4 (\sum_{k=1}^3 t^{k,1}_{i,j}u^k + \sum_{k=1}^3 t^{k,2}_{i,j}u^k)&= |\Omega_i|F(x_i).\\
		\end{aligned}
	\end{equation}
	But the flux stencil across each edge is possibly smaller, often just four points.
	\par
	In figure \ref{fig:L-triangles} we see the criterion in practice for a homogenous medium: In figure \ref{fig:paralellogram-L} all L-triangles are used by two half-edges, and they are chosen in the same way throughout the domain. In figure \ref{fig:complicated-L} there are some triangles that overlap, this is due to the fact that some L-triangles are used by only one half edge.
	\begin{figure}[H]
		\centering
		\begin{subfigure}[b]{0.8\textwidth}
			\centering
			\includegraphics[width=\textwidth]{L-triangles_paralellogram.pdf}
			\caption{Parallelogram grid, all triangles are chose similarly.}
			\label{fig:paralellogram-L}
		\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.8\textwidth}
			\centering
			\includegraphics[width=\textwidth]{L-triangles_complex.pdf}
			\caption{Complicated grid, note that some of the L-triangles overlap.}
			\label{fig:complicated-L}
		\end{subfigure}
		\caption{Examples of L-triangles(in red) in a domain with homogenous permability tensor.}
		\label{fig:L-triangles}
	\end{figure}
	The observation in figure \ref{fig:paralellogram-L} can be stated as a theorem:
	\begin{theorem}[Cao, Y., Helmig, R. and Wohlmuth, B.I. (2009),\cite{https://doi.org/10.1002/num.20525}]
		\label{th:L_triangulation}
		For homogeneous media and uniform parallelogram grids, the MPFA L-method
		has a seven-point cell stencil for the discretization of each interior cell, ie. the discretization of each cell is a seven point stencil including the center cell and the six closest potential cells, as shown in \ref{fig:paralellogram-L}.
	\end{theorem}
	In case of parallelogram grid with heterogeneous permeability, it may also happen that one gets overlapping L-triangles. This is the case even if the permeability only changes as a scalar in the domain. In figure \ref{fig:L-triangles-heterogeneous} the L-triangles are shown for a random, scalar permeability. Let $K_{m,n}$ be the permeability of the $m$th cell in $y$ direction and $n$th cell in $x$ direction. Then the random permeability used in figure \ref{fig:L-triangles-heterogeneous} given by
	\begin{equation}
		K_{n,m} = (e^{\hat{x}}-1)^2
	\end{equation}
	where $\hat{x}$ is a random sample drawn from a uniform distribution over $[0,1)$. We see that two of the L-triangles overlap. This is due to some combination of permeability at four neighbouring cells. Also note that the permeability is not so low that it causes numerical rounding errors, as $\min_{m,n}K_{m,n}=0.0017$ in figure \ref{fig:L-triangles-heterogeneous}.
	\begin{figure}[H]
		\centering
		\includegraphics[width=1.1\textwidth]{L-triangles-heterogenous.pdf}
		\caption{L-triangles on a random permeability.}
		\label{fig:L-triangles-heterogeneous}
	\end{figure}


	\par 
	For homogenous media the L-method becomes easier to reason about. We continue with a useful theorem which we will use later:
	
	\begin{lemma}[Cao, Y., Helmig, R. and Wohlmuth, B.I. (2009),\cite{https://doi.org/10.1002/fld.1926}] \label{lemma:L_potential}
		Assume that the permability $\pmb{K}$ is homogenous on $\Omega$, then the flux trough each half edge $e$, computed by the L-method, can be written as
		\begin{equation}
			f_e = -\pmb{K} \nabla p_h \cdot \pmb{n}_e
		\end{equation}
		Where $\pmb{n}_e$ is the scaled normal vector to the half edge $e$, having the same length as $e$. $p_h$ is a linear scalar field uniquely given by the potential values at the three cellcenters chosen by the L-method.
		\begin{figure}[H]
			\centering
			\includegraphics{Right choice linear potential.pdf}
			\caption{Simplified L-triangle, the original L-triangle i shown in figure \ref{fig:three sin x}. The vector $\nu_1$ is perpendicular to the edge between $x_1$ and $x_2$, with the same length as the edge it is perpendicular to. Same for $\nu_2$.}
			\label{fig:L-triangle-potential}
		\end{figure}
		Moreover, the gradient $\nabla p_h$, is given by:
		\begin{equation}\label{eq:L-potential}
			\nabla p_h = -\frac{1}{2F}[(p_1 - p_2)\nu_1 + (p_3 - p_2)\nu_2 ].
		\end{equation}
		Where $F$ is the the area of the simplified L-triangle with corners $x_1$, $x_2$ and $x_4$, see figure  \ref{fig:L-triangle-potential}. An expression like \eqref{eq:L-potential} can be obtained for the other choice of L-triangle as well.
	\end{lemma}
	\begin{figure}[H]
		\centering
		\includegraphics{right choice 2.pdf}	
		\caption{Original L-triangle with notations in proof.}
		\label{fig:original right choice}
	\end{figure}
	\begin{proof}
		It is enough to check that the jump $[\nabla p]$ is zero on $e_1$ and $e_2$ on the original L-triangle in figure \ref{fig:original right choice}. Let $\pmb{t}_{e_1}$ and $\pmb{n}_{e_1} $be the tangent and normal vector to $e_1$. Since we require potential continuity on each half edge, we get:
		\begin{equation}
			[\nabla p \cdot \pmb{t}_{e_1}]=0.
		\end{equation}
		Using the fact that $\pmb{K}$ is symmetric and homogenous, we obtain:
		\begin{equation}
			[\pmb{K} \nabla p \cdot \pmb{n}_{e_1}]=[\nabla p \cdot \pmb{K}^T \pmb{n}_{e_1}]=[\nabla p \cdot \pmb{K}\pmb{n}_{e_1}]=0.
		\end{equation}
		Where we used flux continuity across each half edge in the last equality. Since $\pmb{K}$ is positive definite, we have that $\pmb{K}\pmb{n}_{e_1}$ and $\pmb{t}_{e_1}$ are independent, thus $[\nabla p]=0$ on $e_1$. Same arguments holds for $e_2$. Hence $\nabla p$ is constant on the original L-triangle and the desired result follows.
	\end{proof}
	\begin{remark}
		The above lemma suggests that we can obtain the transmissibility coefficients without solving a system of equations for each half edge. This simplifies implementation, but it's only possible for homogenous media.
	\end{remark}
	\begin{remark}
		In the case of heterogeneous media, we do not easily get meaningful, physical interpretations of the transmissibility coefficients. Like the harmonic mean, as we did for TPFA. 
	\end{remark}
	\par 
	To conclude; the L-method is the most sophisticated method. It has the best monotonicity properties, but it requires more work for assembling the matrix. It is also more complicated to implement, especially for more dimensions.
	\todo[inline]{explain how we compute transmissibility coefficients in detail for the L-method}
	\todo[inline]{compare O and L method and explain that L-method has better monotonicity properties}
	\todo[inline]{quickly mention standard ways of dealing with boundary conditions}
	\section*{Time Discretization}	\addcontentsline{toc}{section}{Time Discretization}
	
	

\end{document}